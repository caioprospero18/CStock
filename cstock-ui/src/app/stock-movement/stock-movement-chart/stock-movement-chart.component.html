<div class="container">
  <div class="header">
    <h2>Top 5 Produtos - Movimentações de Estoque

      <span class="loading-badge" *ngIf="loading">CARREGANDO...</span>
    </h2>

    <div class="controls">
      <div class="period-selector">
        <label for="periodSelect">Período:</label>
        <p-dropdown
          [options]="periodOptions"
          [(ngModel)]="selectedPeriod"
          (onChange)="onPeriodChange()"
          placeholder="Selecione o período"
          [style]="{'width': '200px'}">
        </p-dropdown>
      </div>

      <div class="refresh-controls">
        <button pButton
                class= "custom-refresh-btn"
                (click)="forceRefresh()"
                [disabled]="loading">

          Atualizar Agora
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading">
    <p-progressSpinner></p-progressSpinner>
    <span>Carregando dados...</span>
  </div>

  <div *ngIf="!loading && !hasData()" class="no-data">
    <p>Nenhum dado de movimentação encontrado para o período selecionado.</p>
    <button pButton
            icon="pi pi-refresh"
            class="p-button-outlined"
            (click)="forceRefresh()">
      Tentar Novamente
    </button>
  </div>

  <div *ngIf="!loading && hasData()" class="charts-container">
    <div class="chart-card">
      <div class="chart-header">
        <h3>Top 5 Entradas - {{ getPeriodLabel() }}</h3>
        <span class="chart-update-info" *ngIf="topEntries.length > 0">
          Atualizado às {{ getCurrentTime() }}
        </span>
      </div>

      <div *ngIf="topEntries.length > 0" class="chart-wrapper">
        <canvas #entryChart width="400" height="300"></canvas>
      </div>

      <div *ngIf="topEntries.length === 0" class="no-chart-data">
        <p>Nenhuma entrada registrada no período</p>
      </div>

      <div class="data-table" *ngIf="topEntries.length > 0">
        <p-table [value]="topEntries" [paginator]="false" [rows]="10">
          <ng-template pTemplate="header">
            <tr>
              <th>Produto</th>
              <th>Quantidade Total</th>
              <th>Última Atualização</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.productName }}</td>
              <td class="quantity entry">{{ item.totalQuantity }}</td>
              <td class="update-time">{{ getCurrentTime() }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3>Top 5 Saídas - {{ getPeriodLabel() }}</h3>
        <span class="chart-update-info" *ngIf="topExits.length > 0">
          Atualizado às {{ getCurrentTime() }}
        </span>
      </div>

      <div *ngIf="topExits.length > 0" class="chart-wrapper">
        <canvas #exitChart width="400" height="300"></canvas>
      </div>

      <div *ngIf="topExits.length === 0" class="no-chart-data">
        <p>Nenhuma saída registrada no período</p>
      </div>

      <div class="data-table" *ngIf="topExits.length > 0">
        <p-table [value]="topExits" [paginator]="false" [rows]="10">
          <ng-template pTemplate="header">
            <tr>
              <th>Produto</th>
              <th>Quantidade Total</th>
              <th>Última Atualização</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.productName }}</td>
              <td class="quantity exit">{{ item.totalQuantity }}</td>
              <td class="update-time">{{ getCurrentTime() }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>

  <div class="footer-info" *ngIf="!loading">
    <p>
      <i class="pi pi-info-circle"></i>
      Os gráficos são atualizados automaticamente a cada 30 segundos.
      <span *ngIf="hasData()">Última verificação: {{ getCurrentTime() }}</span>
    </p>
  </div>
</div>
